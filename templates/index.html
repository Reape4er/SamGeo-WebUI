<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта Leaflet с инструментами рисования</title>

    <!-- Подключение стилей Leaflet -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <!-- Подключение скрипта Leaflet -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>

    <!-- Подключение стилей и скрипта Leaflet.draw -->
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
        integrity="sha512-gc3xjCmIy673V6MyOAZhIW93xhM9ei1I+gLbmFjUHIjocENRsLX/QUE1htk5q1XV2D/iie/VQ8DXI6Vu8bexvQ=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    />
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"
        integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    ></script>

</head>
<body>
    <div id="map" style="width: 100%; height: 900px;"></div>
    <div id="controls">
        <label for="box-threshold">Box Threshold:</label>
        <input type="range" id="box-threshold" name="box-threshold" min="0" max="1" step="0.01" value="0.21">
        <span id="box-threshold-value">0.21</span>

        <label for="text-threshold">Text Threshold:</label>
        <input type="range" id="text-threshold" name="text-threshold" min="0" max="1" step="0.01" value="0.21">
        <span id="text-threshold-value">0.21</span>

        <label for="text-prompt">Text Prompt:</label>
        <input type="text" id="text-prompt" name="text-prompt" placeholder="Enter your prompt here">

        <button id="submit-button" onclick="sendData()">Submit</button>
    </div>

    <!-- Включаем фрагмент управления слоями -->
    {% include 'controls.html' %}

    <script>
        var map = L.map('map').setView([55.751244, 37.618423], 10); // Создаем и центрируем карту на Москве
    
        L.tileLayer(
            'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri',
            name: 'Esri Satellite'
        }).addTo(map);
    
        // Инициализируем объект overlays и добавляем контроллер слоев
        var overlays = {};
        var layerControl = L.control.layers(null, overlays).addTo(map);
    
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        var drawControl = new L.Control.Draw({
            draw: {
                polyline: false,
                polygon: false,
                circle: false,
                circlemarker: false,
                marker: false,
                rectangle: true
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);
        
        // Сохранение последней созданной области
        var drawnData = null;
        map.on('draw:created', function (event) {
            drawnItems.clearLayers();
            var layer = event.layer;
            drawnItems.addLayer(layer);
            drawnData = layer.toGeoJSON(); 
            console.log(drawnData)
        });
    
        document.getElementById('box-threshold').addEventListener('input', function() {
            document.getElementById('box-threshold-value').textContent = this.value;
        });
    
        document.getElementById('text-threshold').addEventListener('input', function() {
            document.getElementById('text-threshold-value').textContent = this.value;
        });
    
        // Инициализация объекта для хранения слоев
        window.layers = {};
    
        // Функция для добавления нового слоя
        function addLayerToControl(name, layer) {
            window.layers[name] = layer; 
            layerControl.addOverlay(layer, name);
            updateLayerSelect();
        }
    
        // Функция для обновления выпадающего списка слоев
        function updateLayerSelect() {
            var layerSelect = document.getElementById('layer-select');
            layerSelect.innerHTML = ''; // Очищаем список
    
            for (var name in window.layers) {
                var option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                layerSelect.appendChild(option);
            }
        }
    
        // Функция sendData
        async function sendData() {
            try {
                // Получение значений из элементов управления
                const boxThreshold = document.getElementById('box-threshold').value;
                const textThreshold = document.getElementById('text-threshold').value;
                const textPrompt = document.getElementById('text-prompt').value;
    
                // Подготовка данных для отправки
                const data = {
                    boxThreshold: boxThreshold,
                    textThreshold: textThreshold,
                    textPrompt: textPrompt,
                    drawnData: drawnData
                };
    
                // Отправка данных на локальный сервер
                const response = await fetch('http://127.0.0.1:5000/segmentation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const geojson = await response.json()
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.statusText);
                }
                console.log(geojson.features)
    
                // Создаем новый GeoJSON слой
                var geojsonLayer = L.geoJSON(geojson, {
                    style: {
                        color: "#ff0000",
                        weight: 2,
                        fillOpacity: 0.3
                    }
                }).addTo(map);
    
                // Добавляем слой в контроллер и обновляем интерфейс
                var layerName = "GeoJSON Layer " + Object.keys(window.layers).length;
                addLayerToControl(layerName, geojsonLayer);
    
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }
    </script>
    <style>
        #controls {
            position: absolute;
            top: 220px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #controls label {
            display: block;
            margin-top: 10px;
        }

        #controls input[type="range"] {
            width: 100%;
        }

        #submit-button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #submit-button:hover {
            background-color: #0056b3;
        }
    </style>
</body>
</html>